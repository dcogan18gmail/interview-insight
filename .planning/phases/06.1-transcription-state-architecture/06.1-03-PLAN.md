---
phase: 06.1-transcription-state-architecture
plan: 03
type: execute
wave: 2
depends_on: ['06.1-01']
files_modified:
  - src/features/dashboard/components/ProjectEntry.tsx
  - src/features/dashboard/components/TranscriptPanel.tsx
  - src/features/dashboard/components/MetadataPanel.tsx
  - src/features/settings/SettingsPage.tsx
  - src/features/settings/components/ApiKeyForm.tsx
autonomous: true

must_haves:
  truths:
    - 'Sidebar shows animated spinner next to the actively transcribing project'
    - 'Sidebar shows orange dot for interrupted projects (distinct from amber dot for cancelled)'
    - 'Settings page warns user about changing API key during active transcription'
    - 'TranscriptPanel shows recovery card for interrupted projects with Resume button'
    - 'MetadataPanel StatusBadge renders correctly for interrupted status'
  artifacts:
    - path: 'src/features/dashboard/components/ProjectEntry.tsx'
      provides: 'Animated spinner for active transcription, orange dot for interrupted'
      contains: 'useTranscriptionState'
    - path: 'src/features/dashboard/components/TranscriptPanel.tsx'
      provides: 'Interrupted status recovery card'
      contains: 'interrupted'
    - path: 'src/features/dashboard/components/MetadataPanel.tsx'
      provides: 'StatusBadge style for interrupted status'
      contains: 'interrupted'
    - path: 'src/features/settings/components/ApiKeyForm.tsx'
      provides: 'Warning/disable during active transcription'
      contains: 'useTranscriptionState'
  key_links:
    - from: 'src/features/dashboard/components/ProjectEntry.tsx'
      to: 'src/contexts/TranscriptionContext.tsx'
      via: 'useTranscriptionState for active project detection'
      pattern: 'useTranscriptionState'
    - from: 'src/features/settings/components/ApiKeyForm.tsx'
      to: 'src/contexts/TranscriptionContext.tsx'
      via: 'useTranscriptionState for transcription-active check'
      pattern: 'useTranscriptionState'
---

<objective>
Add background visibility indicators to the sidebar, handle the interrupted status in UI components, and add API key change warnings during active transcription.

Purpose: The user decided on specific visibility behaviors: animated spinner in sidebar for active transcription, orange dot for interrupted, warning on API key changes during transcription. This plan implements all background visibility and the interrupted status UI.

Output: Updated ProjectEntry with spinner/indicators, TranscriptPanel with interrupted recovery, MetadataPanel with interrupted badge, ApiKeyForm with transcription-active warning.
</objective>

<execution_context>
@/Users/david.cogan@postman.com/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david.cogan@postman.com/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-transcription-state-architecture/06.1-CONTEXT.md
@.planning/phases/06.1-transcription-state-architecture/06.1-RESEARCH.md
@.planning/phases/06.1-transcription-state-architecture/06.1-01-SUMMARY.md
@src/features/dashboard/components/ProjectEntry.tsx
@src/features/dashboard/components/TranscriptPanel.tsx
@src/features/dashboard/components/MetadataPanel.tsx
@src/features/settings/SettingsPage.tsx
@src/features/settings/components/ApiKeyForm.tsx
@src/contexts/TranscriptionContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sidebar indicators and TranscriptPanel interrupted status</name>
  <files>
    src/features/dashboard/components/ProjectEntry.tsx
    src/features/dashboard/components/TranscriptPanel.tsx
    src/features/dashboard/components/MetadataPanel.tsx
  </files>
  <action>
**Step 1: Update ProjectEntry.tsx with sidebar indicators**

Import `useTranscriptionState` from `@/contexts/TranscriptionContext`.

Add active transcription detection:

```typescript
const transcriptionState = useTranscriptionState();
const isActivelyTranscribing =
  transcriptionState.activeProjectId === project.id &&
  transcriptionState.isTranscribing;
```

Update the indicator rendering. Currently there's an amber dot for cancelled/error (`isIncomplete`). Expand to three cases:

1. **Active transcription (uploading/processing):** animated spinner

   ```tsx
   {
     isActivelyTranscribing && (
       <span
         className="ml-1.5 inline-block h-2 w-2 flex-shrink-0 animate-spin rounded-full border border-indigo-500 border-t-transparent"
         title="Transcribing..."
       />
     );
   }
   ```

2. **Interrupted (browser refresh/crash):** orange dot with pulse animation

   ```tsx
   {
     !isActivelyTranscribing && project.status === 'interrupted' && (
       <span
         className="ml-1.5 inline-block h-2 w-2 flex-shrink-0 animate-pulse rounded-full bg-orange-400"
         title="Transcription interrupted â€” click to resume"
       />
     );
   }
   ```

3. **Cancelled or error:** amber dot (existing, but now only shows when NOT actively transcribing AND NOT interrupted)
   Update the `isIncomplete` logic:
   ```typescript
   const isIncomplete =
     !isActivelyTranscribing &&
     project.status !== 'interrupted' &&
     (project.status === 'cancelled' || project.status === 'error');
   ```

Also update the navigation click handler. Currently it blocks navigation for actively transcribing projects when on `/project/new`. With the context-based architecture, the transcription survives navigation, so remove this guard. Allow free navigation to any project at any time:

```typescript
const handleClick = () => {
  if (!editing) {
    navigate(`/project/${project.id}`);
  }
};
```

**Step 2: Update TranscriptPanel.tsx for interrupted status**

Add a new status branch for `'interrupted'` between the cancelled and completed sections. This shows a recovery card distinct from cancelled:

```tsx
if (project.status === 'interrupted') {
  return (
    <div className="p-6">
      {/* Interrupted recovery card */}
      <div className="mb-6 rounded-lg border border-orange-200 bg-orange-50 p-4">
        <h3 className="text-sm font-semibold text-orange-900">
          Transcription was interrupted
        </h3>
        <p className="mt-1 text-sm text-orange-700">
          This transcription was interrupted by a page refresh or browser crash.
          {project.segmentCount > 0
            ? ` ${project.segmentCount} segment${project.segmentCount !== 1 ? 's' : ''} were recovered.`
            : ' No segments were saved.'}
        </p>
        <div className="mt-3 flex gap-3">
          <button
            onClick={() => navigate('/project/new')}
            className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-indigo-700"
          >
            Resume Transcription
          </button>
        </div>
      </div>

      {/* Show partial transcript if available */}
      {segments && segments.length > 0 && (
        <div className="opacity-70">
          <p className="mb-3 text-xs font-medium uppercase tracking-wide text-slate-400">
            Partial Transcript
          </p>
          <TranscriptView transcript={segments} projectName={project.name} />
        </div>
      )}
    </div>
  );
}
```

Key distinction from cancelled:

- Orange border/bg (not amber) -- per user decision "distinct from cancelled"
- Title says "interrupted" not "cancelled"
- Copy explains it was a page refresh/crash (not user action)
- Button says "Resume Transcription" (not "Re-upload & Transcribe")
- The resume button navigates to `/project/new` for now (a future enhancement could use fileUri for resume-without-re-upload within 48h)

**Step 3: Update MetadataPanel.tsx StatusBadge**

In the `styles` Record inside the `StatusBadge` function, add the `interrupted` status:

```typescript
interrupted: 'bg-orange-100 text-orange-700',
```

This is needed because the Record type is `Record<ProjectMetadata['status'], string>` which now includes 'interrupted'. Without this entry, TypeScript will error.
</action>
<verify> - `npx tsc --noEmit` passes with zero errors - `npx eslint src/features/dashboard/components/ProjectEntry.tsx src/features/dashboard/components/TranscriptPanel.tsx src/features/dashboard/components/MetadataPanel.tsx` passes - `npm run build` succeeds
</verify>
<done>
ProjectEntry shows animated spinner for active transcription, orange pulse dot for interrupted, amber dot for cancelled/error. TranscriptPanel shows orange recovery card for interrupted projects. MetadataPanel StatusBadge handles interrupted status. Free navigation allowed for all projects.
</done>
</task>

<task type="auto">
  <name>Task 2: Settings page API key warning during active transcription</name>
  <files>
    src/features/settings/SettingsPage.tsx
    src/features/settings/components/ApiKeyForm.tsx
  </files>
  <action>
**Step 1: Update ApiKeyForm.tsx**

Import `useTranscriptionState` from `@/contexts/TranscriptionContext`.

Add at the top of the component:

```typescript
const transcriptionState = useTranscriptionState();
const isTranscriptionActive = transcriptionState.isTranscribing;
```

When `isTranscriptionActive` is true:

1. **Disable the "Clear Key" / "Remove" button** (whatever the existing clear action is). Add `disabled={isTranscriptionActive}` to prevent accidentally removing the key mid-transcription.
2. **Show an inline warning message** above or below the API key form:
   ```tsx
   {
     isTranscriptionActive && (
       <div className="mt-3 rounded-md border border-amber-200 bg-amber-50 p-3">
         <p className="text-sm text-amber-800">
           <span className="font-medium">Warning:</span> A transcription is
           currently in progress. Changing or removing your API key will cause
           it to fail.
         </p>
       </div>
     );
   }
   ```
3. **Do NOT block saving a new key** -- only warn. The user might legitimately need to fix an invalid key. But clearing the key should be blocked (disabled button).

Read the current ApiKeyForm to understand its exact structure and adapt the warning placement accordingly.

**Step 2: Update SettingsPage.tsx (optional enhancement)**

If SettingsPage has any key-related UI outside of ApiKeyForm, add the same `isTranscriptionActive` check. Based on current code, SettingsPage just renders `<ApiKeyForm />` in a card, so no changes needed to SettingsPage.tsx itself. However, the SettingsPage is listed in files_modified for potential adjustments.

If no SettingsPage changes are needed after examining ApiKeyForm, skip this file.
</action>
<verify> - `npx tsc --noEmit` passes with zero errors - `npx eslint src/features/settings/components/ApiKeyForm.tsx src/features/settings/SettingsPage.tsx` passes - `npm run build` succeeds
</verify>
<done>
ApiKeyForm shows warning message during active transcription. Clear/remove key button is disabled during active transcription. New key can still be saved (with warning). Settings page fully accessible during transcription per user decision.
</done>
</task>

</tasks>

<verification>
1. `npm run build` -- production build succeeds
2. `npx tsc --noEmit` -- zero TypeScript errors
3. `npx eslint src/` -- no new lint errors
4. Verify: ProjectEntry.tsx imports useTranscriptionState and renders spinner for active project
5. Verify: ProjectEntry.tsx renders orange pulse dot for interrupted status
6. Verify: TranscriptPanel.tsx has 'interrupted' status branch with orange recovery card
7. Verify: MetadataPanel.tsx StatusBadge has 'interrupted' style
8. Verify: ApiKeyForm.tsx shows warning and disables clear during active transcription
</verification>

<success_criteria>

- Sidebar shows animated spinner (indigo) next to the actively transcribing project name
- Sidebar shows orange pulsing dot for interrupted projects (distinct from cancelled amber)
- Sidebar shows amber dot for cancelled/error (existing, preserved)
- TranscriptPanel shows orange recovery card for interrupted projects with "Resume Transcription" button
- MetadataPanel StatusBadge renders correctly for all 7 statuses including interrupted
- ApiKeyForm warns user and disables key removal during active transcription
- Free navigation works for all projects (no blocking guards)
- Build and type-check pass cleanly
  </success_criteria>

<output>
After completion, create `.planning/phases/06.1-transcription-state-architecture/06.1-03-SUMMARY.md`
</output>
