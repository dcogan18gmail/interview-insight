---
phase: 06.1-transcription-state-architecture
plan: 02
subsystem: ui
tags:
  [
    react-context,
    toast,
    sonner,
    navigation,
    transcription,
    renderless-component,
  ]

# Dependency graph
requires:
  - phase: 06.1-transcription-state-architecture
    plan: 01
    provides: TranscriptionContext with split state/actions, useTranscriptionState, useTranscriptionActions
provides:
  - Thin re-export useTranscription.ts (backward compat)
  - Context-consuming ProjectPage with live transcription display and in-progress guard
  - CenterPanel routing active transcriptions to live view
  - TranscriptionWatcher renderless component for background toast notifications
affects: [06.1-03, sidebar-indicators, settings-api-key-warning]

# Tech tracking
tech-stack:
  added: []
  patterns:
    [
      context-consumer-rewiring,
      renderless-watcher-component,
      ref-based-transition-detection,
    ]

key-files:
  created: [src/features/dashboard/components/TranscriptionWatcher.tsx]
  modified:
    [
      src/features/project/hooks/useTranscription.ts,
      src/features/project/ProjectPage.tsx,
      src/features/dashboard/components/CenterPanel.tsx,
      src/features/dashboard/DashboardLayout.tsx,
    ]

key-decisions:
  - 'useTranscription.ts gutted to thin re-export (9 lines) -- all logic lives in TranscriptionContext'
  - 'ProjectPage uses reactive useEffect for completion/error/cancelled navigation instead of lifecycle sync'
  - 'Transcription-in-progress guard blocks FileUpload when isTranscribing, with link to active project'
  - 'TranscriptionWatcher mounted in DashboardLayout (dashboard-wide), acceptable that settings page misses toasts'
  - 'Nav-away toast uses prevPathRef pattern to detect leaving active project page'

patterns-established:
  - 'Renderless watcher pattern: component returns null, uses useRef + useEffect for transition detection'
  - 'Context consumer rewiring: thin re-export preserves import paths while logic moves to context'

# Metrics
duration: 3m 06s
completed: 2026-02-08
---

# Phase 06.1 Plan 02: Consumer Rewiring and TranscriptionWatcher Summary

**Rewired ProjectPage/CenterPanel to TranscriptionContext with in-progress guard, live view resume, and background toast notifications via TranscriptionWatcher**

## Performance

- **Duration:** 3m 06s
- **Started:** 2026-02-08T23:11:49Z
- **Completed:** 2026-02-08T23:14:55Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments

- Gutted useTranscription.ts from 311 lines to 9-line thin re-export -- all state machine logic now exclusively in TranscriptionContext
- ProjectPage consumes context hooks (useTranscriptionState/useTranscriptionActions) instead of owning local state machine
- Added transcription-in-progress guard that blocks concurrent uploads with "View Active Transcription" button
- CenterPanel routes active transcription projects to ProjectPage for live view (ProgressStepper + LiveTranscriptView)
- Created TranscriptionWatcher renderless component with nav-away toast (3s), completion toast (8s, clickable), and error toast (persistent, clickable)
- Removed lifecycle useEffect that synced machineState to project status (now handled by provider)
- Removed statusMap and \_displayStatus (no longer needed without LoadingState)

## Task Commits

Each task was committed atomically:

1. **Task 1: Gut useTranscription hook, rewire ProjectPage, update CenterPanel** - `e9eefd4` (feat)
2. **Task 2: Create TranscriptionWatcher for toast notifications** - `6edafe0` (feat)

## Files Created/Modified

- `src/features/project/hooks/useTranscription.ts` - Gutted to thin re-export of context hooks (9 lines)
- `src/features/project/ProjectPage.tsx` - Rewired to consume TranscriptionContext, added in-progress guard and reactive navigation
- `src/features/dashboard/components/CenterPanel.tsx` - Routes active transcriptions to ProjectPage live view
- `src/features/dashboard/components/TranscriptionWatcher.tsx` - New renderless component for background toast notifications
- `src/features/dashboard/DashboardLayout.tsx` - Mounted TranscriptionWatcher as sibling to Sidebar

## Decisions Made

- Gutted useTranscription.ts to a thin re-export rather than deleting it, preserving backward compatibility for any remaining imports
- ProjectPage uses reactive useEffect watching transcriptionState.state for completion/error/cancelled navigation, replacing the old lifecycle sync useEffect that was coupled to the local state machine
- Transcription-in-progress guard checks `isTranscribing` (not `state === 'idle'`) since the context state reflects the global transcription, not page-local state
- TranscriptionWatcher placed in DashboardLayout rather than App.tsx -- acceptable that toasts are missed on settings page (brief navigation, sidebar still updates)
- Used useRef pattern for prev-state and prev-path tracking in TranscriptionWatcher to detect transitions without adding state that would cause re-renders

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed impossible guard condition in ProjectPage**

- **Found during:** Task 1 (rewiring ProjectPage)
- **Issue:** Plan suggested checking `transcriptionState.state === 'idle' && transcriptionState.isTranscribing` for the in-progress guard. These conditions are mutually exclusive since `isTranscribing` is derived from `['uploading', 'processing', 'cancelling'].includes(state)`.
- **Fix:** Changed guard to `isNew && !createdProjectId && transcriptionState.isTranscribing` which correctly triggers when user visits /project/new while another transcription runs.
- **Files modified:** src/features/project/ProjectPage.tsx
- **Verification:** Logic review confirmed conditions are satisfiable; `npx tsc --noEmit` passes
- **Committed in:** e9eefd4 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 bug fix)
**Impact on plan:** Guard condition fix was necessary for correctness. No scope creep.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All transcription consumers now use TranscriptionContext -- state survives route navigation
- Plan 03 can add sidebar indicators (active spinner, interrupted warning) using useTranscriptionState
- Settings page API key warning during active transcription can be added in Plan 03
- The old useTranscription hook is a thin re-export and can be safely deleted once all imports are verified

## Self-Check: PASSED

- FOUND: src/features/project/hooks/useTranscription.ts
- FOUND: src/features/project/ProjectPage.tsx
- FOUND: src/features/dashboard/components/CenterPanel.tsx
- FOUND: src/features/dashboard/components/TranscriptionWatcher.tsx
- FOUND: src/features/dashboard/DashboardLayout.tsx
- FOUND: 06.1-02-SUMMARY.md
- FOUND: commit e9eefd4
- FOUND: commit 6edafe0

---

_Phase: 06.1-transcription-state-architecture_
_Completed: 2026-02-08_
