---
phase: 02-development-tooling
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - tsconfig.json
  - services/geminiService.ts
  - package.json
  - .husky/pre-commit
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "TypeScript strict mode is enabled and codebase compiles with zero errors"
    - "All dependencies are pinned to exact versions (no ^ or ~ ranges, no 'latest')"
    - "Pre-commit hooks block commits with lint errors and auto-fix formatting"
    - "GitHub Actions CI pipeline runs lint, type-check, and build on PRs to main"
  artifacts:
    - path: "tsconfig.json"
      provides: "TypeScript strict config"
      contains: "strict"
    - path: ".husky/pre-commit"
      provides: "Pre-commit hook running lint-staged"
      contains: "lint-staged"
    - path: ".github/workflows/ci.yml"
      provides: "CI pipeline definition"
      contains: "npm run lint"
    - path: "package.json"
      provides: "Pinned dependencies, lint-staged config, prepare script"
      contains: "lint-staged"
  key_links:
    - from: ".husky/pre-commit"
      to: "package.json"
      via: "lint-staged config in package.json"
      pattern: "lint-staged"
    - from: ".github/workflows/ci.yml"
      to: "package.json"
      via: "npm scripts (lint, type-check, build)"
      pattern: "npm run"
    - from: "tsconfig.json"
      to: "services/geminiService.ts"
      via: "strict mode requires undefined guard"
      pattern: "noUncheckedIndexedAccess"
---

<objective>
Enable TypeScript strict mode (fixing the 2 known errors), pin all dependencies to exact versions, set up Husky + lint-staged pre-commit hooks, and create the GitHub Actions CI pipeline.

Purpose: Completes the development tooling phase by adding strict type checking, reproducible builds via pinned versions, a commit-time quality gate, and CI automation. Together with Plan 01, this fully satisfies all Phase 2 requirements (QUAL-01 through QUAL-05, DEPL-01).
Output: Strict tsconfig, pinned package.json, working pre-commit hooks, and CI pipeline.
</objective>

<execution_context>
@/Users/david.cogan@postman.com/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david.cogan@postman.com/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-development-tooling/02-CONTEXT.md
@.planning/phases/02-development-tooling/02-RESEARCH.md
@.planning/phases/02-development-tooling/02-01-SUMMARY.md
@package.json
@tsconfig.json
@services/geminiService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable TypeScript strict mode and pin all dependencies</name>
  <files>
    tsconfig.json
    services/geminiService.ts
    package.json
  </files>
  <action>
    1. Update `tsconfig.json`:
       - Add `"strict": true` and `"noUncheckedIndexedAccess": true` to compilerOptions
       - Remove `"experimentalDecorators": true` (not used in codebase)
       - Remove `"useDefineForClassFields": false` (not used in codebase)
       - Add `"exclude": ["netlify/edge-functions"]` at the top level (edge functions use Deno types, not npm)

    2. Fix the TypeScript strict mode error in `services/geminiService.ts` around line 331. The `noUncheckedIndexedAccess` flag makes array indexing return `T | undefined`. Fix:
       ```typescript
       // Before:
       onProgress(100, allSegments[allSegments.length - 1]);

       // After:
       const lastSegment = allSegments[allSegments.length - 1];
       if (lastSegment) {
         onProgress(100, lastSegment);
       }
       ```

    3. Pin all dependencies in `package.json` to exact versions (remove all `^` and `~` prefixes):
       - Check `node_modules/@google/genai/package.json` for the exact installed version of `@google/genai` (currently `"latest"`)
       - Check `node_modules/` for each dependency's actual installed version
       - Replace every dependency version with the exact installed version (no `^`, no `~`, no `"latest"`)
       - This covers BOTH `dependencies` and `devDependencies` sections
       - Example: `"react": "^18.3.1"` becomes `"react": "18.3.1"` (use the exact version from node_modules, which may differ from the range)

    4. Run type-check to confirm zero errors:
       ```bash
       npx tsc --noEmit
       ```

    5. Run build to confirm nothing broke:
       ```bash
       npm run build
       ```
  </action>
  <verify>
    `npx tsc --noEmit` exits with code 0 (zero TypeScript errors).
    `npm run build` succeeds.
    `grep '"strict"' tsconfig.json` returns a match.
    `grep '"noUncheckedIndexedAccess"' tsconfig.json` returns a match.
    `grep '"latest"' package.json` returns NO match (no more "latest").
    `grep '\^' package.json` returns NO match in dependencies (no caret ranges).
    `grep '~' package.json` returns NO match in dependencies (no tilde ranges).
  </verify>
  <done>
    TypeScript strict mode + noUncheckedIndexedAccess enabled. Both strict mode errors fixed. All dependencies pinned to exact versions. `tsc --noEmit` passes with zero errors. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Set up Husky + lint-staged pre-commit hooks and GitHub Actions CI</name>
  <files>
    package.json
    .husky/pre-commit
    .github/workflows/ci.yml
  </files>
  <action>
    1. Install Husky and lint-staged with exact pinning:
       ```bash
       npm install --save-dev --save-exact husky@9.1.7 lint-staged@16.2.7
       ```

    2. Initialize Husky:
       ```bash
       npx husky init
       ```
       This creates `.husky/pre-commit` and adds `"prepare": "husky"` to package.json scripts.

    3. Replace the contents of `.husky/pre-commit` with:
       ```bash
       npx lint-staged
       ```

    4. Add lint-staged configuration to `package.json` (top level, alongside "scripts"):
       ```json
       "lint-staged": {
         "*.{ts,tsx}": [
           "eslint --fix",
           "prettier --write"
         ],
         "*.{json,md,css,html}": [
           "prettier --write"
         ]
       }
       ```

    5. Add `"type-check": "tsc --noEmit"` to the scripts section of `package.json` (if not already present from Task 1).

    6. Create `.github/workflows/ci.yml`:
       ```yaml
       name: CI

       on:
         pull_request:
           branches: [main]
         push:
           branches: [main]

       jobs:
         quality:
           runs-on: ubuntu-latest
           steps:
             - uses: actions/checkout@v4

             - uses: actions/setup-node@v4
               with:
                 node-version: '22'
                 cache: 'npm'

             - run: npm ci

             - name: Lint
               run: npm run lint

             - name: Type Check
               run: npm run type-check

             - name: Build
               run: npm run build
       ```

    7. Run the full verification suite to confirm everything works together:
       ```bash
       npm run lint && npm run type-check && npm run build
       ```
  </action>
  <verify>
    `test -f .husky/pre-commit && echo "exists"` confirms hook file exists.
    `cat .husky/pre-commit` contains "lint-staged".
    `test -f .github/workflows/ci.yml && echo "exists"` confirms CI file exists.
    `grep '"prepare"' package.json` returns a match (Husky prepare script).
    `grep '"lint-staged"' package.json` returns a match (lint-staged config).
    `grep '"type-check"' package.json` returns a match (type-check script).
    `npm run lint && npm run type-check && npm run build` all exit 0.
  </verify>
  <done>
    Husky pre-commit hook runs lint-staged on every commit (blocking on lint errors, auto-fixing formatting). GitHub Actions CI pipeline runs lint, type-check, and build on all PRs and pushes to main. All npm scripts (`lint`, `type-check`, `build`) pass.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- exits 0, strict mode active with zero errors
2. `npm run lint` -- exits 0, linting passes
3. `npm run build` -- exits 0, build succeeds
4. `grep -c '"latest"\|"\^"\|"~"' package.json` in dependencies sections -- returns 0 (all pinned)
5. `cat .husky/pre-commit` -- contains "lint-staged"
6. `cat .github/workflows/ci.yml` -- contains lint, type-check, and build steps
7. `grep '"strict": true' tsconfig.json` -- confirms strict mode enabled
8. `grep '"noUncheckedIndexedAccess": true' tsconfig.json` -- confirms strict indexing
</verification>

<success_criteria>
- TypeScript compiles in strict mode with zero errors
- All dependencies pinned to exact versions (QUAL-05 complete)
- Pre-commit hooks via Husky + lint-staged block bad commits (QUAL-03 complete)
- GitHub Actions CI runs lint, type-check, and build on PRs (DEPL-01 complete)
- TypeScript strict + noUncheckedIndexedAccess enabled (QUAL-04 complete)
</success_criteria>

<output>
After completion, create `.planning/phases/02-development-tooling/02-02-SUMMARY.md`
</output>
