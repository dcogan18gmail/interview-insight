---
phase: 06-enhanced-transcription-experience
plan: 03
type: execute
wave: 3
depends_on: ['06-01', '06-02']
files_modified:
  - src/features/project/ProjectPage.tsx
  - src/features/dashboard/components/CenterPanel.tsx
  - src/features/dashboard/components/TranscriptPanel.tsx
  - src/features/dashboard/components/ProjectEntry.tsx
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - 'User sees live growing transcript with progress stepper during active transcription'
    - 'User can cancel in-progress transcription via cancel button with confirmation dialog'
    - 'After cancellation, user sees partial transcript with Resume and Discard options'
    - 'Sidebar shows a subtle indicator on projects with incomplete/cancelled transcriptions'
    - 'On viewing a project with interrupted transcription, an inline recovery card appears'
    - 'User can retry a failed or interrupted transcription from the project view'
  artifacts:
    - path: 'src/features/project/ProjectPage.tsx'
      provides: 'Rewired transcription flow using ProgressStepper + LiveTranscriptView + cancel confirmation'
      contains: 'ProgressStepper'
    - path: 'src/features/dashboard/components/TranscriptPanel.tsx'
      provides: 'Recovery card for interrupted/cancelled transcriptions with Resume/Discard actions'
      contains: 'interrupted'
    - path: 'src/features/dashboard/components/ProjectEntry.tsx'
      provides: 'Subtle visual indicator for incomplete/cancelled projects in sidebar'
      contains: 'cancelled'
  key_links:
    - from: 'src/features/project/ProjectPage.tsx'
      to: 'src/features/project/hooks/useTranscription.ts'
      via: 'cancel function from useTranscription hook triggers cancellation flow'
      pattern: 'cancel'
    - from: 'src/features/project/ProjectPage.tsx'
      to: 'src/features/project/components/ProgressStepper.tsx'
      via: 'ProgressStepper receives mapped progress data from useTranscription state'
      pattern: 'ProgressStepper'
    - from: 'src/features/project/ProjectPage.tsx'
      to: 'src/features/project/components/LiveTranscriptView.tsx'
      via: 'LiveTranscriptView receives segments from useTranscription state'
      pattern: 'LiveTranscriptView'
    - from: 'src/features/dashboard/components/TranscriptPanel.tsx'
      to: 'src/features/project/ProjectPage.tsx'
      via: 'Recovery actions trigger navigation to /project/new or resume flow'
      pattern: 'Resume'
---

<objective>
Wire the service layer (Plan 01) and UI components (Plan 02) into the existing page structure: replace LoadingState with ProgressStepper + LiveTranscriptView, add cancel confirmation flow, build interruption recovery UI, and add sidebar incomplete indicator.

Purpose: This is the integration plan that connects the engine and display layers to deliver all 7 TRNS requirements to the user. Without this, Plans 01 and 02 are unused building blocks.

Output: Fully functional enhanced transcription experience across ProjectPage, TranscriptPanel, CenterPanel, and Sidebar.
</objective>

<execution_context>
@/Users/david.cogan@postman.com/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david.cogan@postman.com/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-enhanced-transcription-experience/06-CONTEXT.md
@.planning/phases/06-enhanced-transcription-experience/06-RESEARCH.md
@.planning/phases/06-enhanced-transcription-experience/06-01-SUMMARY.md
@.planning/phases/06-enhanced-transcription-experience/06-02-SUMMARY.md
@src/features/project/ProjectPage.tsx
@src/features/dashboard/components/CenterPanel.tsx
@src/features/dashboard/components/TranscriptPanel.tsx
@src/features/dashboard/components/ProjectEntry.tsx
@src/features/dashboard/components/ConfirmDialog.tsx
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire ProjectPage with live transcription display and cancel flow</name>
  <files>
src/features/project/ProjectPage.tsx
src/types/index.ts
  </files>
  <action>
**types/index.ts changes:**
- Add `CANCELLING = 'CANCELLING'` and `CANCELLED = 'CANCELLED'` to `TranscriptionStatus` enum (for LoadingState compatibility and status mapping)

**ProjectPage.tsx changes:**

This is the most complex integration point. The page currently uses LoadingState for the uploading/processing states. Replace it with ProgressStepper + LiveTranscriptView for a fully visible transcription experience.

1. **Import new components and hook returns:**
   - Import `ProgressStepper` from `@/features/project/components/ProgressStepper`
   - Import `LiveTranscriptView` from `@/features/project/components/LiveTranscriptView`
   - Import `ConfirmDialog` from `@/features/dashboard/components/ConfirmDialog`
   - Remove the `LoadingState` import (no longer used in this file)
   - The `useTranscription` hook now returns `cancel` -- destructure it: `const { machineState, startTranscription, reset, cancel } = useTranscription()`

2. **Add local state for cancel confirmation:**

   ```typescript
   const [showCancelConfirm, setShowCancelConfirm] = useState(false);
   ```

3. **Update handleFileSelected to pass projectId:**
   - The `startTranscription` call now needs a 4th argument `projectId`:

   ```typescript
   startTranscription(
     fileData.file,
     fileData.type,
     fileData.duration,
     project.id
   );
   ```

   (Use the created project's ID)

4. **Map machine state to progress stepper stage:**

   ```typescript
   function getProgressStage(
     state: string,
     progress: number
   ): 'uploading' | 'processing' | 'transcribing' | 'complete' {
     if (state === 'uploading') return 'uploading';
     if (state === 'processing' && progress < 5) return 'processing';
     if (state === 'processing') return 'transcribing';
     if (state === 'completed') return 'complete';
     return 'uploading';
   }
   ```

5. **Map progress to unified 0-100:**
   The useTranscription hook reports:
   - During 'uploading': 0-100 of upload progress
   - During 'processing': 0-100 of transcription progress

   Map to unified progress:

   ```typescript
   function getUnifiedProgress(state: string, rawProgress: number): number {
     if (state === 'uploading') return Math.round(rawProgress * 0.25); // 0-25%
     if (state === 'processing') {
       if (rawProgress < 1) return 27; // Processing/init = 25-30%
       return 30 + Math.round(rawProgress * 0.65); // 30-95%
     }
     if (state === 'completed') return 100;
     return 0;
   }
   ```

6. **Cancel confirmation handlers:**

   ```typescript
   const handleCancelClick = () => setShowCancelConfirm(true);
   const handleConfirmCancel = () => {
     setShowCancelConfirm(false);
     cancel();
   };
   const handleCancelDismiss = () => setShowCancelConfirm(false);
   ```

7. **Replace the processing stage render block:**
   Remove the existing `(machineState.state === 'uploading' || machineState.state === 'processing')` block that renders `<LoadingState>`.

   Replace with:

   ```tsx
   {
     (machineState.state === 'uploading' ||
       machineState.state === 'processing' ||
       machineState.state === 'cancelling') && (
       <div className="w-full">
         {/* Progress stepper + bar (inline, scrolls away) */}
         <ProgressStepper
           currentStage={getProgressStage(
             machineState.state,
             machineState.progress
           )}
           progress={getUnifiedProgress(
             machineState.state,
             machineState.progress
           )}
           timeEstimate={null} // ProgressStepper calculates internally from progress + elapsed
           onCancel={
             machineState.state !== 'cancelling' ? handleCancelClick : undefined
           }
           isComplete={false}
         />

         {/* Live transcript display */}
         <div className="mt-4" style={{ maxHeight: 'calc(100vh - 250px)' }}>
           <LiveTranscriptView
             segments={machineState.transcript}
             staleSegments={machineState.staleSegments}
             isStreaming={machineState.state !== 'cancelling'}
           />
         </div>
       </div>
     );
   }
   ```

8. **Add cancelled state render block** (after the error block):

   ```tsx
   {
     machineState.state === 'cancelled' && (
       <div className="w-full">
         {/* Inline recovery notification */}
         <div className="mb-4 rounded-lg border border-amber-200 bg-amber-50 p-4">
           <h3 className="text-sm font-semibold text-amber-900">
             Transcription Cancelled
           </h3>
           <p className="mt-1 text-sm text-amber-700">
             {machineState.transcript.length} segment
             {machineState.transcript.length !== 1 ? 's' : ''} saved.
           </p>
           <div className="mt-3 flex gap-3">
             <button
               onClick={() => {
                 // Resume: re-start transcription with same project
                 if (createdProjectId) {
                   // For now, navigate to new to re-upload. File object is lost on cancel.
                   // If fileUri is still valid, we could skip upload.
                   handleReset();
                 }
               }}
               className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-indigo-700"
             >
               Start Fresh
             </button>
           </div>
         </div>

         {/* Show partial transcript */}
         {machineState.transcript.length > 0 && (
           <TranscriptView transcript={machineState.transcript} />
         )}
       </div>
     );
   }
   ```

9. **Update the status sync effect** to handle cancelling/cancelled:
   In the useEffect that syncs machineState.state to project status, add:

   ```typescript
   } else if (machineState.state === 'cancelled' && project.status !== 'cancelled') {
     updateProject({ ...project, status: 'cancelled' });
   }
   ```

   Remove or leave the cancelling state unsynced (it's transient).

10. **Add the cancel confirmation dialog** at the bottom of the JSX return, before the closing `</div>`:

    ```tsx
    <ConfirmDialog
      open={showCancelConfirm}
      title="Cancel Transcription"
      message="Cancel transcription? Partial results will be saved."
      confirmLabel="Cancel Transcription"
      cancelLabel="Keep Going"
      variant="danger"
      onConfirm={handleConfirmCancel}
      onCancel={handleCancelDismiss}
    />
    ```

11. **Update the statusMap** to include cancelling and cancelled:
    ```typescript
    cancelling: TranscriptionStatus.CANCELLING,
    cancelled: TranscriptionStatus.CANCELLED,
    ```

Keep the existing error and completed render blocks. The file upload (idle) block stays unchanged.
</action>
<verify>

1. `npx tsc --noEmit` passes
2. ProjectPage renders ProgressStepper + LiveTranscriptView during uploading/processing
3. Cancel button triggers ConfirmDialog
4. Cancelled state shows partial transcript with recovery options
5. Status sync effect handles cancelled state
   </verify>
   <done>
   ProjectPage uses ProgressStepper and LiveTranscriptView instead of LoadingState, cancel confirmation flows through ConfirmDialog, cancelled state shows partial results with recovery actions, and project status syncs through all transcription states.
   </done>
   </task>

<task type="auto">
  <name>Task 2: TranscriptPanel recovery card and ProjectEntry sidebar indicator</name>
  <files>
src/features/dashboard/components/TranscriptPanel.tsx
src/features/dashboard/components/ProjectEntry.tsx
src/features/dashboard/components/CenterPanel.tsx
  </files>
  <action>
**TranscriptPanel.tsx changes:**

This component renders when a user clicks into an existing project from the sidebar. It needs to handle `cancelled` status and show an inline recovery notification for interrupted transcriptions.

1. **Add a new status block for 'cancelled'** (between the error block and the completed/loading block):

   ```tsx
   if (project.status === 'cancelled') {
     return (
       <div className="p-6">
         {/* Inline recovery card */}
         <div className="mb-6 rounded-lg border border-amber-200 bg-amber-50 p-4">
           <h3 className="text-sm font-semibold text-amber-900">
             Transcription was interrupted
           </h3>
           <p className="mt-1 text-sm text-amber-700">
             {project.segmentCount > 0
               ? `${project.segmentCount} segment${project.segmentCount !== 1 ? 's' : ''} recovered.`
               : 'No segments were saved.'}
           </p>
           <div className="mt-3 flex gap-3">
             <button
               onClick={() => navigate('/project/new')}
               className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-indigo-700"
             >
               Re-upload & Transcribe
             </button>
           </div>
         </div>

         {/* Show partial transcript if available */}
         {segments && segments.length > 0 && (
           <div className="opacity-70">
             <p className="mb-3 text-xs font-medium uppercase tracking-wide text-slate-400">
               Partial Transcript
             </p>
             <TranscriptView transcript={segments} />
           </div>
         )}
       </div>
     );
   }
   ```

2. **Import useNavigate** from react-router at the top of the file (needed for the recovery button)

3. **Load segments for cancelled projects too:**
   The existing `useEffect` only loads segments when the component mounts. The segments are already loaded for completed projects. No change needed -- the `getTranscript` call already runs regardless of status, and the `segments` state is set. The existing code after the status checks only guards on `project.status === 'completed'` implicitly (by falling through idle/uploading/processing/error). Now `cancelled` is handled explicitly above the completed block, so it works.

4. **Handle 'uploading' and 'processing' with more context:**
   The existing spinner for uploading/processing is fine for now. When a user navigates to an in-progress transcription from the sidebar, they see the spinner. The live transcript view is only shown in ProjectPage during active transcription (same session). This is acceptable because Phase 6 context says "No auto-detection alert on app launch -- the subtle sidebar indicator is sufficient. Interrupted state revealed when user clicks into the project."

**ProjectEntry.tsx changes:**

Add a subtle visual indicator for projects with incomplete/cancelled status.

1. **Add indicator logic** inside the component, after the existing variables:

   ```typescript
   const isIncomplete =
     project.status === 'cancelled' || project.status === 'error';
   ```

2. **Render a small indicator dot** next to the project label. Inside the `<div className="min-w-0 flex-1">` container, after the project label (the `<div className="truncate text-sm font-medium">` or the input), add:

   ```tsx
   {
     isIncomplete && !editing && (
       <span
         className="ml-1.5 inline-block h-2 w-2 flex-shrink-0 rounded-full bg-amber-400"
         title={
           project.status === 'cancelled'
             ? 'Transcription incomplete'
             : 'Transcription failed'
         }
       />
     );
   }
   ```

   To make this work inline with the text, adjust the label container to use `flex items-center`:
   - Change the non-editing label from just a `<div className="truncate text-sm font-medium">` to wrap in a flex container:

   ```tsx
   <div className="flex items-center">
     <div className="truncate text-sm font-medium">
       {getProjectLabel(project)}
     </div>
     {isIncomplete && (
       <span
         className="ml-1.5 inline-block h-2 w-2 flex-shrink-0 rounded-full bg-amber-400"
         title={
           project.status === 'cancelled'
             ? 'Transcription incomplete'
             : 'Transcription failed'
         }
       />
     )}
   </div>
   ```

**CenterPanel.tsx changes:**

The CenterPanel routes to ProjectPage for new projects and TranscriptPanel for existing ones. No structural changes needed -- CenterPanel already renders TranscriptPanel for existing projects, which now handles the cancelled state. However, verify that the `'cancelled'` status is not accidentally caught by an earlier condition.

Review the CenterPanel code: it checks `projectId === 'new'` then looks up the project. If project exists, it renders `<TranscriptPanel project={project} />`. This is correct -- TranscriptPanel now handles the cancelled state. No changes needed to CenterPanel.

If CenterPanel has any status-based routing that would prevent TranscriptPanel from rendering for cancelled projects, fix it. Based on current code, there are no such guards -- CenterPanel just passes the project through.
</action>
<verify>

1. `npx tsc --noEmit` passes
2. `npx eslint src/features/dashboard/components/TranscriptPanel.tsx src/features/dashboard/components/ProjectEntry.tsx` passes
3. TranscriptPanel renders recovery card for cancelled projects with segment count and re-upload button
4. ProjectEntry shows amber dot indicator for cancelled and error projects
5. Partial transcript is displayed below the recovery card (dimmed) when segments exist
   </verify>
   <done>
   TranscriptPanel shows inline recovery card for interrupted/cancelled transcriptions with partial data display. ProjectEntry shows a subtle amber dot indicator for incomplete projects. CenterPanel correctly routes cancelled projects to TranscriptPanel.
   </done>
   </task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx eslint src/features/project/ProjectPage.tsx src/features/dashboard/components/TranscriptPanel.tsx src/features/dashboard/components/ProjectEntry.tsx src/features/dashboard/components/CenterPanel.tsx src/types/index.ts` passes
3. Full transcription flow: upload -> progress stepper visible -> segments appear live -> transcript auto-scrolls -> completion
4. Cancel flow: click Cancel -> confirmation dialog -> confirm -> partial transcript saved -> recovery options shown
5. Sidebar indicator: cancelled/error projects show amber dot
6. Recovery flow: navigate to cancelled project -> recovery card with segment count -> re-upload button
7. TRNS-01: Live growing transcript visible during processing (LiveTranscriptView in ProjectPage)
8. TRNS-02: Scroll up holds position, "Jump to latest" pill appears (useAutoScroll)
9. TRNS-03: Cancel button in ProgressStepper triggers cancel via useTranscription hook
10. TRNS-04: Partial results saved via debouncedSaveTranscript during processing
11. TRNS-05: Interrupted transcriptions detected via project.status === 'cancelled' in TranscriptPanel
12. TRNS-06: Retry via re-upload button in TranscriptPanel recovery card
13. TRNS-07: ProgressStepper shows 4-stage progress with time estimate
</verification>

<success_criteria>

- ProjectPage renders ProgressStepper + LiveTranscriptView during active transcription (replaces LoadingState)
- Cancel button triggers ConfirmDialog with "Cancel transcription? Partial results will be saved."
- Cancelled state shows partial transcript with "Start Fresh" action
- TranscriptPanel shows inline recovery card for cancelled projects
- ProjectEntry shows amber dot for cancelled/error projects in sidebar
- All 7 TRNS requirements are satisfied end-to-end
- No TypeScript or lint errors
  </success_criteria>

<output>
After completion, create `.planning/phases/06-enhanced-transcription-experience/06-03-SUMMARY.md`
</output>
