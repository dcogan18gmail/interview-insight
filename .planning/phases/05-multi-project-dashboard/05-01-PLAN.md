---
phase: 05-multi-project-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/storageService.types.ts
  - src/services/storageService.ts
  - src/app/App.tsx
  - src/app/Layout.tsx
  - src/features/dashboard/DashboardLayout.tsx
  - src/features/dashboard/components/Sidebar.tsx
  - src/features/dashboard/components/CenterPanel.tsx
  - src/features/dashboard/components/MetadataPanel.tsx
  - src/features/dashboard/DashboardPage.tsx
autonomous: true

must_haves:
  truths:
    - 'ProjectMetadata includes interviewee, interviewer, participants, interviewDate, originalLanguage, and location fields (all optional strings)'
    - 'Schema migration from v1 to v2 runs automatically and adds new fields with null defaults to existing projects'
    - 'App renders a 3-panel layout with collapsible sidebar, center transcript area, and right metadata panel'
    - 'Sidebar shows project list sorted by most recently updated with project name, short-form date, and original language'
    - 'Sidebar is collapsible via a toggle button'
    - 'New Project button appears in sidebar header'
  artifacts:
    - path: 'src/services/storageService.types.ts'
      provides: 'Extended ProjectMetadata with new optional fields, CURRENT_SCHEMA_VERSION = 2'
      contains: 'interviewee'
    - path: 'src/services/storageService.ts'
      provides: 'v1-to-v2 migration in migrations array'
      contains: 'version: 2'
    - path: 'src/features/dashboard/DashboardLayout.tsx'
      provides: '3-panel layout shell with Sidebar, center Outlet, and MetadataPanel'
      contains: 'Sidebar'
    - path: 'src/features/dashboard/components/Sidebar.tsx'
      provides: 'Collapsible sidebar with sorted project list and New Project button'
      contains: 'collapsed'
  key_links:
    - from: 'src/app/App.tsx'
      to: 'src/features/dashboard/DashboardLayout.tsx'
      via: 'react-router nested Route element'
      pattern: 'DashboardLayout'
    - from: 'src/features/dashboard/components/Sidebar.tsx'
      to: 'src/contexts/ProjectsContext.tsx'
      via: 'useProjects hook'
      pattern: 'useProjects'
    - from: 'src/services/storageService.ts'
      to: 'src/services/storageService.types.ts'
      via: 'migration reads existing projects and adds new fields'
      pattern: 'version: 2'
---

<objective>
Extend the storage schema with metadata fields, implement v1-to-v2 migration, and build the foundational 3-panel layout shell (sidebar + center + right panel) per the Linear-inspired design decisions.

Purpose: Establishes the structural foundation that Plans 02 and 03 build upon. The schema extension unblocks the metadata panel. The 3-panel layout unblocks all UI work.
Output: Extended types, working migration, 3-panel layout rendering with collapsible sidebar showing project list, functional placeholder center and right panels.
</objective>

<execution_context>
@/Users/david.cogan@postman.com/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david.cogan@postman.com/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multi-project-dashboard/05-CONTEXT.md
@.planning/phases/05-multi-project-dashboard/05-RESEARCH.md
@src/services/storageService.types.ts
@src/services/storageService.ts
@src/app/App.tsx
@src/app/Layout.tsx
@src/features/dashboard/DashboardPage.tsx
@src/contexts/ProjectsContext.tsx
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ProjectMetadata schema and implement v1-to-v2 migration</name>
  <files>
    src/services/storageService.types.ts
    src/services/storageService.ts
  </files>
  <action>
**In `storageService.types.ts`:**

1. Change `CURRENT_SCHEMA_VERSION` from `1` to `2`.

2. Add new optional fields to `ProjectMetadata` interface (after `segmentCount`):

   ```typescript
   // Extended metadata fields (v2) -- user-editable, start blank
   interviewee: string | null; // Interviewee/subject name
   interviewer: string | null; // Interviewer name
   participants: string | null; // Other participants (free text)
   interviewDate: string | null; // Date of interview (ISO 8601 or user-entered string)
   originalLanguage: string | null; // Original language of the interview
   location: string | null; // Location where interview took place
   ```

   Use `string | null` (not optional `?`) so the fields are always present after migration but can be null when not yet filled. This makes the "needs info" indicator logic simpler (check `=== null`).

**In `storageService.ts`:**

3. Add the v1-to-v2 migration to the `migrations` array (currently empty `[]`):

   ```typescript
   const migrations: Migration[] = [
     {
       version: 2,
       up: () => {
         const raw = localStorage.getItem(STORAGE_KEYS.PROJECTS);
         if (!raw) return;

         let projects: unknown[];
         try {
           projects = JSON.parse(raw);
         } catch {
           return; // Corrupted data handled elsewhere
         }

         if (!Array.isArray(projects)) return;

         const migrated = projects.map((p) => {
           if (typeof p !== 'object' || p === null) return p;
           const obj = p as Record<string, unknown>;
           return {
             ...obj,
             interviewee: obj['interviewee'] ?? null,
             interviewer: obj['interviewer'] ?? null,
             participants: obj['participants'] ?? null,
             interviewDate: obj['interviewDate'] ?? null,
             originalLanguage: obj['originalLanguage'] ?? null,
             location: obj['location'] ?? null,
           };
         });

         localStorage.setItem(STORAGE_KEYS.PROJECTS, JSON.stringify(migrated));
       },
     },
   ];
   ```

4. Update `validateProjectMetadataArray` to accept but not require the new fields. After the existing `segmentCount` check, add validation that if the new fields are present, they must be `string | null`:

   ```typescript
   // v2 fields: optional during migration, always present after
   const stringOrNullFields = [
     'interviewee',
     'interviewer',
     'participants',
     'interviewDate',
     'originalLanguage',
     'location',
   ] as const;
   for (const field of stringOrNullFields) {
     const val = obj[field];
     if (val !== undefined && val !== null && typeof val !== 'string') {
       return {
         ok: false,
         error: `Item ${i}: ${field} must be a string or null`,
       };
     }
   }
   ```

   This tolerates v1 data (where fields are missing/undefined) and validates v2 data (where they should be string or null).

5. Update the `createProject` function to include the new fields with `null` defaults:
   ```typescript
   const project: ProjectMetadata = {
     id: crypto.randomUUID(),
     name,
     createdAt: now,
     updatedAt: now,
     status: 'idle',
     fileInfo,
     segmentCount: 0,
     interviewee: null,
     interviewer: null,
     participants: null,
     interviewDate: null,
     originalLanguage: null,
     location: null,
   };
   ```
     </action>
     <verify>
   Run `npx tsc --noEmit` -- should compile with zero errors. The new fields are typed and the migration function is syntactically valid. Verify by inspecting the migration array is no longer empty.
     </verify>
     <done>
   ProjectMetadata has 6 new `string | null` fields. CURRENT_SCHEMA_VERSION is 2. Migration array has one entry (version 2) that adds null defaults to existing projects. Validator accepts both v1 and v2 data. createProject includes new fields.
     </done>
   </task>

<task type="auto">
  <name>Task 2: Build 3-panel layout shell with collapsible sidebar</name>
  <files>
    src/app/App.tsx
    src/app/Layout.tsx
    src/features/dashboard/DashboardLayout.tsx
    src/features/dashboard/components/Sidebar.tsx
    src/features/dashboard/components/CenterPanel.tsx
    src/features/dashboard/components/MetadataPanel.tsx
    src/features/dashboard/DashboardPage.tsx
  </files>
  <action>
**Routing changes in `App.tsx`:**

Update routing to use nested layout for the 3-panel dashboard. The DashboardLayout wraps routes that need the sidebar:

```tsx
import DashboardLayout from '@/features/dashboard/DashboardLayout';

export default function App() {
  return (
    <SettingsProvider>
      <ProjectsProvider>
        <BrowserRouter>
          <Routes>
            <Route element={<Layout />}>
              <Route element={<DashboardLayout />}>
                <Route index element={<CenterPanel />} />
                <Route path="project/:projectId" element={<CenterPanel />} />
              </Route>
              <Route path="settings" element={<SettingsPage />} />
            </Route>
          </Routes>
        </BrowserRouter>
      </ProjectsProvider>
    </SettingsProvider>
  );
}
```

The key change: DashboardLayout is a nested layout route that renders the sidebar + right panel, with center content from the Outlet.

**Layout.tsx changes:**

Remove the `max-w-5xl` constraint from `<main>` since the 3-panel layout needs full width. Change `<main>` to:

```tsx
<main className="flex-1">
  <Outlet />
</main>
```

Also update the outer div to `flex flex-col min-h-screen` so the layout fills the viewport. The header stays as-is (sticky, with its own max-w-5xl container).

**Create `DashboardLayout.tsx`:**

This is the 3-panel shell. It renders:

- Left: `<Sidebar />` (collapsible, fixed width)
- Center: `<Outlet />` (flexible, takes remaining space)
- Right: `<MetadataPanel />` (fixed width, only visible when a project is selected)

```tsx
import { Outlet, useParams } from 'react-router';
import Sidebar from './components/Sidebar';
import MetadataPanel from './components/MetadataPanel';

export default function DashboardLayout() {
  const { projectId } = useParams();
  const hasSelectedProject = projectId !== undefined && projectId !== 'new';

  return (
    <div className="flex h-[calc(100vh-65px)]">
      <Sidebar />
      <div className="flex-1 overflow-y-auto">
        <Outlet />
      </div>
      {hasSelectedProject && <MetadataPanel projectId={projectId} />}
    </div>
  );
}
```

The height `h-[calc(100vh-65px)]` accounts for the header. Adjust the pixel value to match the actual header height (inspect Layout header padding/border).

**Create `Sidebar.tsx`:**

Collapsible sidebar with project list. Key requirements:

- Fixed width (e.g., `w-64`) when open, narrow icon strip (e.g., `w-12`) when collapsed
- Toggle button for collapse/expand (use a chevron/hamburger icon)
- "New Project" button in sidebar header (per LOCKED decision)
- Project list sorted by `updatedAt` descending (most recent first)
- Each project entry shows: project name (or interviewee if set), short-form date, original language
- Selected project is visually highlighted
- Click on project entry navigates to `/project/:id`

```tsx
import { useState } from 'react';
import { useNavigate, useParams } from 'react-router';
import { useProjects } from '@/contexts/ProjectsContext';

export default function Sidebar() {
  const [collapsed, setCollapsed] = useState(false);
  const { state } = useProjects();
  const navigate = useNavigate();
  const { projectId } = useParams();

  // Sort projects by updatedAt descending
  const sortedProjects = [...state.projects].sort(
    (a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime()
  );

  return (
    <aside
      className={`flex flex-col border-r border-slate-200 bg-white transition-all duration-200 ${collapsed ? 'w-12' : 'w-64'}`}
    >
      {/* Sidebar header */}
      <div className="flex items-center justify-between border-b border-slate-200 p-3">
        {!collapsed && (
          <button
            onClick={() => navigate('/project/new')}
            className="flex items-center gap-1.5 rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-medium text-white transition-colors hover:bg-indigo-700"
          >
            {/* Plus icon SVG */}
            <svg
              className="h-4 w-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth="2"
                d="M12 4v16m8-8H4"
              />
            </svg>
            New Project
          </button>
        )}
        <button
          onClick={() => setCollapsed(!collapsed)}
          className="rounded p-1 text-slate-400 hover:bg-slate-100 hover:text-slate-600"
          title={collapsed ? 'Expand sidebar' : 'Collapse sidebar'}
          aria-label={collapsed ? 'Expand sidebar' : 'Collapse sidebar'}
        >
          {/* Chevron icon -- points left when open, right when collapsed */}
          <svg
            className={`h-4 w-4 transition-transform ${collapsed ? 'rotate-180' : ''}`}
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
        </button>
      </div>

      {/* Project list */}
      {!collapsed && (
        <nav className="flex-1 overflow-y-auto py-2" aria-label="Project list">
          {sortedProjects.map((project) => {
            const isSelected = project.id === projectId;
            const displayDate = new Date(project.updatedAt).toLocaleDateString(
              undefined,
              { month: 'short', day: 'numeric' }
            );
            return (
              <button
                key={project.id}
                onClick={() => navigate(`/project/${project.id}`)}
                className={`w-full px-3 py-2 text-left transition-colors ${
                  isSelected
                    ? 'bg-indigo-50 text-indigo-700'
                    : 'text-slate-700 hover:bg-slate-50'
                }`}
              >
                <div className="truncate text-sm font-medium">
                  {project.name}
                </div>
                <div className="mt-0.5 flex items-center gap-2 text-xs text-slate-400">
                  <span>{displayDate}</span>
                  {project.originalLanguage && (
                    <span>{project.originalLanguage}</span>
                  )}
                </div>
              </button>
            );
          })}
        </nav>
      )}
    </aside>
  );
}
```

**Create `CenterPanel.tsx`:**

A functional placeholder that handles both "no project selected" (index route) and "project selected" (project/:id route) states. For now:

- If no projectId in URL params: show a simple welcome message with "New Project" button (placeholder -- Plan 03 will enhance)
- If projectId === 'new': render the existing file upload flow (from ProjectPage)
- If projectId is a real ID: show a placeholder "Transcript will appear here" message (Plan 03 will enhance)

Import and reuse the existing ProjectPage logic for the `new` case. For other cases, provide minimal functional placeholders.

```tsx
import { useParams, useNavigate } from 'react-router';
import { useProjects } from '@/contexts/ProjectsContext';
import ProjectPage from '@/features/project/ProjectPage';

export default function CenterPanel() {
  const { projectId } = useParams();
  const navigate = useNavigate();
  const { state } = useProjects();

  // No project selected -- welcome view
  if (!projectId) {
    return (
      <div className="flex h-full flex-col items-center justify-center p-8">
        <h2 className="mb-2 text-2xl font-bold text-slate-800">
          Welcome to Interview Insight
        </h2>
        <p className="mb-6 text-slate-500">
          Select a project from the sidebar or start a new transcription.
        </p>
        <button
          onClick={() => navigate('/project/new')}
          className="flex items-center gap-2 rounded-lg bg-indigo-600 px-6 py-3 font-medium text-white shadow-lg shadow-indigo-200 transition-all hover:bg-indigo-700"
        >
          <svg
            className="h-5 w-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="2"
              d="M12 4v16m8-8H4"
            />
          </svg>
          New Project
        </button>
        {state.projects.length > 0 && (
          <p className="mt-4 text-sm text-slate-400">
            {state.projects.length} project
            {state.projects.length !== 1 ? 's' : ''} in your library
          </p>
        )}
      </div>
    );
  }

  // New project flow
  if (projectId === 'new') {
    return (
      <div className="mx-auto max-w-2xl p-8">
        <ProjectPage />
      </div>
    );
  }

  // Existing project -- placeholder for Plan 03
  const project = state.projects.find((p) => p.id === projectId);
  if (!project) {
    return (
      <div className="flex h-full items-center justify-center p-8">
        <div className="text-center">
          <p className="text-slate-500">Project not found.</p>
          <button
            onClick={() => navigate('/')}
            className="mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-700"
          >
            Back to dashboard
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="flex h-full items-center justify-center p-8">
      <div className="text-center">
        <h3 className="text-lg font-semibold text-slate-700">{project.name}</h3>
        <p className="mt-2 text-sm text-slate-400">
          Transcript view will be implemented in Plan 03.
        </p>
      </div>
    </div>
  );
}
```

**Create `MetadataPanel.tsx`:**

A minimal placeholder right panel that shows basic project info. Plan 03 will build it out with editable fields.

```tsx
import { useProjects } from '@/contexts/ProjectsContext';

interface MetadataPanelProps {
  projectId: string;
}

export default function MetadataPanel({ projectId }: MetadataPanelProps) {
  const { state } = useProjects();
  const project = state.projects.find((p) => p.id === projectId);

  if (!project) return null;

  return (
    <aside className="w-72 overflow-y-auto border-l border-slate-200 bg-white p-4">
      <h3 className="mb-4 text-sm font-semibold uppercase tracking-wider text-slate-400">
        Project Details
      </h3>
      <div className="space-y-3 text-sm">
        <div>
          <span className="text-slate-400">Status</span>
          <p className="font-medium text-slate-700">{project.status}</p>
        </div>
        <div>
          <span className="text-slate-400">Created</span>
          <p className="font-medium text-slate-700">
            {new Date(project.createdAt).toLocaleDateString()}
          </p>
        </div>
        <div>
          <span className="text-slate-400">Segments</span>
          <p className="font-medium text-slate-700">{project.segmentCount}</p>
        </div>
      </div>
      {/* Full editable metadata fields will be added in Plan 03 */}
    </aside>
  );
}
```

**Remove old `DashboardPage.tsx` content:**

The old DashboardPage is no longer the landing page. It can either be deleted or left as a redirect. Since the routes now use `DashboardLayout` + `CenterPanel`, delete the old DashboardPage.tsx content or repurpose it. Simplest: delete the file since `DashboardLayout` replaces its role.

**Important implementation notes:**

- The Layout.tsx `<main>` must NOT have `max-w-5xl` or centering classes that would constrain the 3-panel layout.
- The header in Layout.tsx should keep its own internal `max-w-5xl` container for the header content.
- Use `overflow-y-auto` on center panel and metadata panel, NOT on the outer flex container, so each panel scrolls independently.
- The sidebar collapse transition should use `transition-all duration-200` for smooth animation.
  </action>
  <verify>

1. Run `npx tsc --noEmit` -- zero errors.
2. Run `npm run dev` and verify:
   - Landing page shows 3-panel layout: sidebar on left, welcome message in center.
   - Sidebar shows "New Project" button and project list (if any projects exist).
   - Sidebar collapse toggle works (clicking hides/shows project list).
   - Clicking a project in sidebar navigates to `/project/:id` and highlights the entry.
   - Clicking "New Project" navigates to `/project/new` and shows file upload.
   - MetadataPanel appears on right when a project is selected.
   - Settings page (`/settings`) still works and does NOT show the sidebar.
3. Run `npm run lint` -- no lint errors.
   </verify>
   <done>
   3-panel layout renders correctly: collapsible sidebar with sorted project list on left, center content area with route-dependent content, right metadata panel for selected projects. Routing updated with nested DashboardLayout. Layout.tsx updated to support full-width content.
   </done>
   </task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run lint` passes
3. App renders 3-panel layout at `/` with sidebar, center welcome view, no right panel
4. Sidebar lists projects sorted by most recently updated
5. Sidebar collapses/expands on toggle click
6. "New Project" button in sidebar header navigates to `/project/new`
7. Clicking a project shows it selected in sidebar, renders placeholder in center, metadata panel on right
8. `/settings` route works without sidebar
9. Schema version is 2 in storageService.types.ts
10. Migration array has one entry for v1->v2
</verification>

<success_criteria>

- 3-panel layout is visually correct: sidebar (fixed ~256px), center (flexible), right panel (~288px)
- Sidebar collapse animation is smooth
- Project list is sorted by updatedAt descending
- All existing routes still function (settings, project/new)
- TypeScript compiles without errors
- ProjectMetadata has 6 new nullable string fields
  </success_criteria>

<output>
After completion, create `.planning/phases/05-multi-project-dashboard/05-01-SUMMARY.md`
</output>
